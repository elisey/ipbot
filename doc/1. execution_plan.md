# Telegram IP Bot - Implementation Plan

Based on the design document and your preferences, here's a step-by-step execution plan. Each step is sized for completion in one AI session.

## Configuration
- Python: 3.13
- Scope: ipify fetcher only (extensible structure for future strategies)
- Testing: Basic unit tests
- Git: Initialize and manage throughout
- Linter/Formatter: ruff with pre-commit hooks

---

## Step 1: Project Foundation & Structure (DONE)
**Goal:** Set up project structure, git, and dependency management

**Actions:**
- Initialize git repository with proper .gitignore
- Create complete directory structure (src/ipbot/, config/, docker/, .github/workflows/, tests/)
- Run `uv init` to create pyproject.toml
- Add dependencies: python-telegram-bot, httpx, PyYAML
- Add dev dependencies: ruff, pytest, pytest-asyncio
- Create README.md with basic setup instructions
- Add .dockerignore
- Remove PyCharm template main.py
- Initial git commit

**Files created:** `.gitignore`, `pyproject.toml`, `README.md`, `.dockerignore`, directory structure

---

## Step 2: Taskfile & Development Tools (DONE)
**Goal:** Set up Taskfile, ruff configuration, and pre-commit hooks

**Actions:**
- Create `Taskfile.yaml` with tasks:
  - `dev` - Run bot locally with uv
  - `test` - Run pytest
  - `lint` - Run ruff check
  - `format` - Run ruff format
  - `format-check` - Check formatting without changes
  - `fix` - Fix formating and fixable lint issues
  - `check` - run format check, lint check, test
- Configure ruff in pyproject.toml (line length, Python version, rules)
- Add `uv add --dev pre-commit`
- Create `.pre-commit-config.yaml` with ruff hooks
- Run `pre-commit install` to set up git hooks
- Test all tasks work correctly
- Commit changes

**Files created:** `Taskfile.yaml`, `.pre-commit-config.yaml`
**Files updated:** `pyproject.toml` (ruff config)

---

## Step 3: Core Strategy Pattern Infrastructure (DONE)
**Goal:** Implement the base fetcher architecture with strategy pattern

**Actions:**
- Create `src/ipbot/__init__.py`
- Implement `src/ipbot/fetchers/__init__.py`
- Implement `src/ipbot/fetchers/base.py` - FetchStrategy ABC with async get_ip()
- Implement `src/ipbot/fetchers/ipify.py` - IpifyStrategy using httpx
- Implement `src/ipbot/factory.py` - Factory that creates fetchers based on config
- Write unit tests for ipify strategy (mocking HTTP calls)
- Run precommit task to verify code quality
- Test that fetcher returns IP correctly
- Commit with passing pre-commit hooks

**Files created:** `base.py`, `ipify.py`, `factory.py`, `test_fetchers.py`

---

## Step 4: Configuration & Logging (DONE)
**Goal:** Implement config loading and logging setup

**Actions:**
- Create `src/ipbot/logger.py` - Console logging setup (INFO level)
- Create `src/ipbot/config.py` - YAML config loader with validation
- Create `config/config.example.yaml` with structure from design doc
- Add config/config.yaml to .gitignore (if not already)
- Write unit tests for config loading
- Test with example config
- Run precommit checks
- Commit changes

**Files created:** `logger.py`, `config.py`, `config.example.yaml`, `test_config.py`

---

## Step 5: Telegram Bot Handler (DONE)
**Goal:** Implement bot command handlers with authorization

**Actions:**
- Create `src/ipbot/bot.py` - Register /ip command handler
- Implement authorization check (owner_id validation)
- Integrate IP fetcher into handler
- Implement error handling and user-friendly messages
- Create `src/ipbot/main.py` - Entry point that builds and runs Application
- Write unit tests for bot handler (mocking telegram API)
- Run precommit checks
- Commit changes

**Files created:** `bot.py`, `main.py`, `test_bot.py`

---

## Step 6: Docker Configuration (DONE)
**Goal:** Create Docker image and docker-compose setup

**Actions:**
- Create `docker/Dockerfile` with Python 3.13-slim base
- Multi-stage build: install deps, copy source
- Set proper CMD for running the bot
- Create `docker-compose.yml` with volume mount for config
- Set restart: always policy
- Add timezone configuration
- Test local docker build
- Commit changes

**Files created:** `docker/Dockerfile`, `docker-compose.yml`

---

## Step 7: GitHub Actions CI/CD (DONE)
**Goal:** Automate Docker image build and push to GHCR

**Actions:**
- Create `.github/workflows/ci-docker-publish.yml`
- Configure triggers: push to main branch
- Set up GHCR authentication with GITHUB_TOKEN
- Build and tag image (sha + latest)
- Push to ghcr.io
- Add workflow badge to README
- Commit changes

**Files created:** `.github/workflows/ci-docker-publish.yml`

---

## Step 8: Documentation & Final Polish (DONE)
**Goal:** Complete documentation and verify everything works end-to-end

**Actions:**
- Enhance README with:
  - Full setup instructions
  - How to get Telegram bot token
  - How to find your Telegram user ID
  - Configuration guide
  - Development workflow (Taskfile commands)
  - Deployment instructions
- Add troubleshooting section
- Verify all tests pass
- Run bot locally to confirm functionality
- Ensure pre-commit hooks working
- Create final git commit
- Tag release v0.1.0

**Files updated:** `README.md`

---

## Success Criteria

After completing all steps, you will have:
✅ Working async Telegram bot responding to /ip command
✅ Strategy pattern for IP fetchers (extensible for future strategies)
✅ Authorization to only respond to your user ID
✅ Ruff linter/formatter with pre-commit hooks
✅ Comprehensive Taskfile for development workflow
✅ Docker containerization with docker-compose
✅ CI/CD pipeline to GHCR
✅ Basic unit test coverage
✅ Complete documentation

Each step is independent enough to be completed in one session, with clear deliverables and testing points.
